<!DOCTYPE html>
<html style="font-family:verdana">

<head>
    <title>Milege</title>
</head>

<body>
    <style>
        * {
            box-sizing: border-box;
        }

        @media print {
            #main * {
                display: none;
            }
        }

        .collapsible {
            background-color: #eee;
            color: #444;
            cursor: pointer;
            padding: 18px;
            width: 100%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 15px;
        }

        .active,
        .collapsible:hover {
            background-color: #ccc;
        }

        .content {
            padding: 0 18px;
            background-color: white;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.2s ease-out;
        }

        .left {
            padding: 18px;
            float: left;
            width: 50%;
        }

        .right {
            padding: 18px;
            float: right;
            width: 50%;
        }

        .clearfix::after {
            content: "";
            clear: both;
            display: table;
        }
    </style>

    <div id="main">
        <h1 style="text-align: center;">Milege</h1>
        <div class="clearfix" style="margin-top:20px;margin-bottom:20px">
            <button type="button" class="collapsible">
                <h2>Informationen</h2>
            </button>
            <div class="content left">
                <dl>
                    <dt>Textfeld:</dt>
                    <dd>Schreibe oder kopiere eine Geschichte in den Kasten.</dd>
                    <br>
                    <dt>Dateien auswählen:</dt>
                    <dd>Suche oder male Bilder dazu und füge sie mit dem "Dateien auswählen"-Knopf ein oder zieh sie mit der Maus auf den Knopf.
                    </dd>
                </dl>
            </div>
            <div class="content left">
                <dl>
                    <dt>Info:</dt>
                    <dd>Die Wörter in der Geschichten werden anhand der Dateinamen der Bilder ersetzt.</dd>
                    <dd>Nach dem Erzeugen, kann man die Geschichte direkt hier im Browser lesen oder Drucken.</dd>
                    <br>
                    <dt><a href="https://github.com/Chaosmeister/Milege">Code</a></dt>
                </dl>
            </div>
        </div>
        <div class="clearfix">
            <div class="left">
                <div style="text-align: center; padding: 20px">Hier die Geschichte rein</div>
                <div contenteditable id="geschichte" style="min-height: 100px;border: solid;"></div>
            </div>
            <div class="right">
                <div style="text-align: center; padding: 20px">Hier die Bilder ablegen</div>
                <input type="file" size="8" id="pictures" accept="image/png, image/jpeg" multiple>
            </div>
        </div>
        <div>
            <button onclick="createStory()">Geschichte erstellen</button>
        </div>
        <div>
            <h2>Hier landet die fertige Geschichte:</h2>
        </div>
    </div>
    <div id="preview" style="border:solid; width=100%; min-height: 100%; line-height:40px;">
    </div>
</body>

<script>
    var coll = document.getElementsByClassName("collapsible");

    for (var i = 0; i < coll.length; i++) {
        coll[i].addEventListener("click", function () {
            this.classList.toggle("active");
            var content = this.nextElementSibling;
            if (content.style.maxHeight) {
                content.style.maxHeight = null;
            } else {
                content.style.maxHeight = content.scrollHeight + "px";
            }
            content = content.nextElementSibling;
            if (content.style.maxHeight) {
                content.style.maxHeight = null;
            } else {
                content.style.maxHeight = content.scrollHeight + "px";
            }
        });
    }

    function createStory() {
        var text = document.getElementById('geschichte').textContent;
        var base64images = convert(document.getElementById('pictures').files);
        createInlineImages(base64images);
        assembleStory(text, base64images);
    };

    function convert(files) {
        var base64images = [];
        for (let i = 0; i < files.length; ++i) {
            const file = files[i];

            if (!file.type.startsWith('image/')) { continue }

            base64images.push({ name: file.name.replace(/\.[^/.]+$/, ""), data: toBase64(file) });
        }
        return base64images;
    }

    const toBase64 = file => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });

    async function createInlineImages(base64images) {

        var style = "<style> .image {width:40px; height:40px; vertical-align: middle; display: inline-block;}";

        for (let i = 0; i < base64images.length; ++i) {
            const image = base64images[i];
            style += "\n ." + image.name + "{background: url(" + await image.data + ") no-repeat left center;background-size: 100% 100%;}";
        }

        style += "\n</style>";

        document.getElementById('preview').innerHTML = style + document.getElementById('preview').innerHTML;
    }

    async function assembleStory(text, images) {
        for (let i = 0; i < images.length; ++i) {
            const image = images[i];
            text = text.replace(image.name, "<div class=\"image " + image.name + "\"></div>");
        }

        document.getElementById('preview').innerHTML = "<span>" + text + "</span>";
    }
</script>

</html>